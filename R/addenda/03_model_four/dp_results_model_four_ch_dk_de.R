


# read results of parameter estimations of model 4 ----

# Switzerland
if (file.exists(paste0(path_results_model_four_ch, "1.rds"))) {
  
  results_model_four_ch_2021_01 <- readRDS(paste0(path_results_model_four_ch, "1.rds"))
  
} else {
  
  results_model_four_ch_2021_01 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "2.rds"))) {
  
  results_model_four_ch_2021_02 <- readRDS(paste0(path_results_model_four_ch, "2.rds"))
  
} else {
  
  results_model_four_ch_2021_02 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "3.rds"))) {
  
  results_model_four_ch_2021_03 <- readRDS(paste0(path_results_model_four_ch, "3.rds"))
  
} else {
  
  results_model_four_ch_2021_03 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "4.rds"))) {
  
  results_model_four_ch_2021_04 <- readRDS(paste0(path_results_model_four_ch, "4.rds"))
  
} else {
  
  results_model_four_ch_2021_04 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "5.rds"))) {
  
  results_model_four_ch_2021_05 <- readRDS(paste0(path_results_model_four_ch, "5.rds"))
  
} else {
  
  results_model_four_ch_2021_05 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "6.rds"))) {
  
  results_model_four_ch_2021_06 <- readRDS(paste0(path_results_model_four_ch, "6.rds"))
  
} else {
  
  results_model_four_ch_2021_06 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "7.rds"))) {
  
  results_model_four_ch_2021_07 <- readRDS(paste0(path_results_model_four_ch, "7.rds"))
  
} else {
  
  results_model_four_ch_2021_07 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "8.rds"))) {
  
  results_model_four_ch_2021_08 <- readRDS(paste0(path_results_model_four_ch, "8.rds"))
  
} else {
  
  results_model_four_ch_2021_08 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "9.rds"))) {
  
  results_model_four_ch_2021_09 <- readRDS(paste0(path_results_model_four_ch, "9.rds"))
  
} else {
  
  results_model_four_ch_2021_09 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "10.rds"))) {
  
  results_model_four_ch_2021_10 <- readRDS(paste0(path_results_model_four_ch, "10.rds"))
  
} else {
  
  results_model_four_ch_2021_10 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "11.rds"))) {
  
  results_model_four_ch_2021_11 <- readRDS(paste0(path_results_model_four_ch, "11.rds"))
  
} else {
  
  results_model_four_ch_2021_11 <- 0
  
}

if (file.exists(paste0(path_results_model_four_ch, "12.rds"))) {
  
  results_model_four_ch_2021_12 <- readRDS(paste0(path_results_model_four_ch, "12.rds"))
  
} else {
  
  results_model_four_ch_2021_12 <- 0
  
}


# Denmark
if (file.exists(paste0(path_results_model_four_dk, "1.rds"))) {
  
  results_model_four_dk_2021_01 <- readRDS(paste0(path_results_model_four_dk, "1.rds"))
  
} else {
  
  results_model_four_dk_2021_01 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "2.rds"))) {
  
  results_model_four_dk_2021_02 <- readRDS(paste0(path_results_model_four_dk, "2.rds"))
  
} else {
  
  results_model_four_dk_2021_02 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "3.rds"))) {
  
  results_model_four_dk_2021_03 <- readRDS(paste0(path_results_model_four_dk, "3.rds"))
  
} else {
  
  results_model_four_dk_2021_03 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "4.rds"))) {
  
  results_model_four_dk_2021_04 <- readRDS(paste0(path_results_model_four_dk, "4.rds"))
  
} else {
  
  results_model_four_dk_2021_04 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "5.rds"))) {
  
  results_model_four_dk_2021_05 <- readRDS(paste0(path_results_model_four_dk, "5.rds"))
  
} else {
  
  results_model_four_dk_2021_05 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "6.rds"))) {
  
  results_model_four_dk_2021_06 <- readRDS(paste0(path_results_model_four_dk, "6.rds"))
  
} else {
  
  results_model_four_dk_2021_06 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "7.rds"))) {
  
  results_model_four_dk_2021_07 <- readRDS(paste0(path_results_model_four_dk, "7.rds"))
  
} else {
  
  results_model_four_dk_2021_07 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "8.rds"))) {
  
  results_model_four_dk_2021_08 <- readRDS(paste0(path_results_model_four_dk, "8.rds"))
  
} else {
  
  results_model_four_dk_2021_08 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "9.rds"))) {
  
  results_model_four_dk_2021_09 <- readRDS(paste0(path_results_model_four_dk, "9.rds"))
  
} else {
  
  results_model_four_dk_2021_09 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "10.rds"))) {
  
  results_model_four_dk_2021_10 <- readRDS(paste0(path_results_model_four_dk, "10.rds"))
  
} else {
  
  results_model_four_dk_2021_10 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "11.rds"))) {
  
  results_model_four_dk_2021_11 <- readRDS(paste0(path_results_model_four_dk, "11.rds"))
  
} else {
  
  results_model_four_dk_2021_11 <- 0
  
}

if (file.exists(paste0(path_results_model_four_dk, "12.rds"))) {
  
  results_model_four_dk_2021_12 <- readRDS(paste0(path_results_model_four_dk, "12.rds"))
  
} else {
  
  results_model_four_dk_2021_12 <- 0
  
}


# Germany
if (file.exists(paste0(path_results_model_four_de, "1.rds"))) {
  
  results_model_four_de_2021_01 <- readRDS(paste0(path_results_model_four_de, "1.rds"))
  
} else {
  
  results_model_four_de_2021_01 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "2.rds"))) {
  
  results_model_four_de_2021_02 <- readRDS(paste0(path_results_model_four_de, "2.rds"))
  
} else {
  
  results_model_four_de_2021_02 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "3.rds"))) {
  
  results_model_four_de_2021_03 <- readRDS(paste0(path_results_model_four_de, "3.rds"))
  
} else {
  
  results_model_four_de_2021_03 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "4.rds"))) {
  
  results_model_four_de_2021_04 <- readRDS(paste0(path_results_model_four_de, "4.rds"))
  
} else {
  
  results_model_four_de_2021_04 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "5.rds"))) {
  
  results_model_four_de_2021_05 <- readRDS(paste0(path_results_model_four_de, "5.rds"))
  
} else {
  
  results_model_four_de_2021_05 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "6.rds"))) {
  
  results_model_four_de_2021_06 <- readRDS(paste0(path_results_model_four_de, "6.rds"))
  
} else {
  
  results_model_four_de_2021_06 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "7.rds"))) {
  
  results_model_four_de_2021_07 <- readRDS(paste0(path_results_model_four_de, "7.rds"))
  
} else {
  
  results_model_four_de_2021_07 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "8.rds"))) {
  
  results_model_four_de_2021_08 <- readRDS(paste0(path_results_model_four_de, "8.rds"))
  
} else {
  
  results_model_four_de_2021_08 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "9.rds"))) {
  
  results_model_four_de_2021_09 <- readRDS(paste0(path_results_model_four_de, "9.rds"))
  
} else {
  
  results_model_four_de_2021_09 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "10.rds"))) {
  
  results_model_four_de_2021_10 <- readRDS(paste0(path_results_model_four_de, "10.rds"))
  
} else {
  
  results_model_four_de_2021_10 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "11.rds"))) {
  
  results_model_four_de_2021_11 <- readRDS(paste0(path_results_model_four_de, "11.rds"))
  
} else {
  
  results_model_four_de_2021_11 <- 0
  
}

if (file.exists(paste0(path_results_model_four_de, "12.rds"))) {
  
  results_model_four_de_2021_12 <- readRDS(paste0(path_results_model_four_de, "12.rds"))
  
} else {
  
  results_model_four_de_2021_12 <- 0
  
}


# read estimated monthly sequencing probabilities of Switzerland, Denmark and Germany during 2021
sequencing_probas_ch_2021_months_0 <- read_csv(file = path_sequencing_probas_ch_2021_months)
sequencing_probas_dk_2021_months_0 <- read_csv(file = path_sequencing_probas_dk_2021_months)
sequencing_probas_de_2021_months_0 <- read_csv(file = path_sequencing_probas_de_2021_months)


# determine mutation probabilities for model 4
mutation_probas_model_four_ch_2021_months <- rep(x = 0.2811, times = 12)
mutation_probas_model_four_dk_2021_months <- rep(x = 0.2811, times = 12)
mutation_probas_model_four_de_2021_months <- rep(x = 0.2811, times = 12)


# determine testing probabilities for model 4
testing_probas_model_four_ch_2021_months <- c(0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.35, 0.35, 0.35, 0.35)
testing_probas_model_four_dk_2021_months <- c(0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.35, 0.35, 0.35, 0.35)
testing_probas_model_four_de_2021_months <- c(0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.576, 0.35, 0.35, 0.35, 0.35)


# create list of results
list_results_model_four_ch_2021 <- list(results_model_four_ch_2021_01, results_model_four_ch_2021_02, results_model_four_ch_2021_03, 
                                        results_model_four_ch_2021_04, results_model_four_ch_2021_05, results_model_four_ch_2021_06,
                                        results_model_four_ch_2021_07, results_model_four_ch_2021_08, results_model_four_ch_2021_09,
                                        results_model_four_ch_2021_10, results_model_four_ch_2021_11, results_model_four_ch_2021_12)

list_results_model_four_dk_2021 <- list(results_model_four_dk_2021_01, results_model_four_dk_2021_02, results_model_four_dk_2021_03,
                                        results_model_four_dk_2021_04, results_model_four_dk_2021_05, results_model_four_dk_2021_06,
                                        results_model_four_dk_2021_07, results_model_four_dk_2021_08, results_model_four_dk_2021_09, 
                                        results_model_four_dk_2021_10, results_model_four_dk_2021_11, results_model_four_dk_2021_12)

list_results_model_four_de_2021 <- list(results_model_four_de_2021_01, results_model_four_de_2021_02, results_model_four_de_2021_03,
                                        results_model_four_de_2021_04, results_model_four_de_2021_05, results_model_four_de_2021_06,
                                        results_model_four_de_2021_07, results_model_four_de_2021_08, results_model_four_de_2021_09, 
                                        results_model_four_de_2021_10, results_model_four_de_2021_11, results_model_four_de_2021_12)


# create summary of results of parameter estimations of model 4 ----
results_model_four_ch_dk_de_2021_months <- data.frame(matrix(data = 0, nrow = 36, ncol = 14))
names(results_model_four_ch_dk_de_2021_months) <- c("month", "country", "sequencing_proba", 
                                                    "R_estimate", "R_lower_cred_int", "R_upper_cred_int", "R_Rhat",
                                                    "k_estimate", "k_lower_cred_int", "k_upper_cred_int", "k_Rhat",
                                                    "mutation_proba", "testing_proba", "detection_proba")

results_model_four_ch_dk_de_2021_months <- results_model_four_ch_dk_de_2021_months %>%
  mutate(month = rep(x=1:12, times=3),
         country = rep(x=c("Switzerland", "Denmark", "Germany"), each=12),
         sequencing_proba = c(sequencing_probas_ch_2021_months_0 %>% pull("seq_proba_ch"), 
                              sequencing_probas_dk_2021_months_0 %>% pull("seq_proba_dk"), 
                              sequencing_probas_de_2021_months_0 %>% pull("seq_proba_de")),
         mutation_proba = c(mutation_probas_model_four_ch_2021_months,
                            mutation_probas_model_four_dk_2021_months,
                            mutation_probas_model_four_de_2021_months),
         testing_proba = c(testing_probas_model_four_ch_2021_months,
                           testing_probas_model_four_dk_2021_months,
                           testing_probas_model_four_de_2021_months))

results_model_four_ch_dk_de_2021_months <- results_model_four_ch_dk_de_2021_months %>%
  mutate(detection_proba = testing_proba * sequencing_proba)

results_model_four_n_divergent <- data.frame(matrix(data = 0, nrow = 36, ncol = 3))
names(results_model_four_n_divergent) <- c("month", "country", "n_divergent")

results_model_four_n_divergent <- results_model_four_n_divergent %>%
  mutate(month = rep(x=1:12, times=3),
         country = rep(x=c("Switzerland", "Denmark", "Germany"), each=12))


for(ii in 1:12) {
  
  results_ii <- list_results_model_four_ch_2021[[ii]]
  
  if (!(is.numeric(results_ii))) {
    
    results_model_four_ch_dk_de_2021_months$R_estimate[ii] <- get_posterior_mean(results_ii, par = c("R"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$R_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$R_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$R_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "Rhat"]
    
    results_model_four_ch_dk_de_2021_months$k_estimate[ii] <- get_posterior_mean(results_ii, par = c("k"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$k_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$k_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$k_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "Rhat"]
    
    results_model_four_n_divergent$n_divergent[ii] <- get_num_divergent(results_ii)
    
    ggsave(plot = rstan::traceplot(results_ii, inc_warmup = TRUE),
           filename = paste0("plots/switzerland/model_four/traceplot_", ii, ".png"),
           width = 5, height = 5, units = c("in"))
    
  }
  
}

for(ii in 13:24) {
  
  results_ii <- list_results_model_four_dk_2021[[ii-12]]
  
  if (!(is.numeric(results_ii))) {
    
    results_model_four_ch_dk_de_2021_months$R_estimate[ii] <- get_posterior_mean(results_ii, par = c("R"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$R_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$R_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$R_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "Rhat"]
    
    results_model_four_ch_dk_de_2021_months$k_estimate[ii] <- get_posterior_mean(results_ii, par = c("k"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$k_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$k_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$k_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "Rhat"]
    
    results_model_four_n_divergent$n_divergent[ii] <- get_num_divergent(results_ii)
    
    ggsave(plot = rstan::traceplot(results_ii, inc_warmup = TRUE),
           filename = paste0("plots/denmark/model_four/traceplot_", ii - 12, ".png"),
           width = 5, height = 5, units = c("in"))
    
  }
  
}

for(ii in 25:36) {
  
  results_ii <- list_results_model_four_de_2021[[ii-24]]
  
  if (!(is.numeric(results_ii))) {
    
    results_model_four_ch_dk_de_2021_months$R_estimate[ii] <- get_posterior_mean(results_ii, par = c("R"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$R_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$R_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$R_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("R"), "Rhat"]
    
    results_model_four_ch_dk_de_2021_months$k_estimate[ii] <- get_posterior_mean(results_ii, par = c("k"))[, "mean-all chains"]
    results_model_four_ch_dk_de_2021_months$k_lower_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "2.5%"]
    results_model_four_ch_dk_de_2021_months$k_upper_cred_int[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "97.5%"]
    results_model_four_ch_dk_de_2021_months$k_Rhat[ii] <- as.data.frame(summary(results_ii)[[1]])[c("k"), "Rhat"]
    
    results_model_four_n_divergent$n_divergent[ii] <- get_num_divergent(results_ii)
    
    ggsave(plot = rstan::traceplot(results_ii, inc_warmup = TRUE),
           filename = paste0("plots/germany/model_four/traceplot_", ii - 24, ".png"),
           width = 5, height = 5, units = c("in"))
    
  }
  
}


# save `results_model_four_ch_dk_de_2021_months` as csv file ----
write_csv(results_model_four_ch_dk_de_2021_months, file = path_results_model_four_ch_dk_de_processed)



# run some checks ----
results_model_four_checks_ch_dk_de <- cbind(results_model_four_n_divergent,
                                            results_model_four_ch_dk_de_2021_months %>%
                                              dplyr::select(c("R_Rhat", "k_Rhat")))

results_model_four_checks_ch <- results_model_four_checks_ch_dk_de %>% filter(country == "Switzerland")
results_model_four_checks_dk <- results_model_four_checks_ch_dk_de %>% filter(country == "Denmark")
results_model_four_checks_de <- results_model_four_checks_ch_dk_de %>% filter(country == "Germany")


# 
# # determine over all mean estimate of Re and k ----
# 
# # Re
# results_model_four_ch_2021_01_R_samples <- rstan::extract(results_model_four_ch_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_02_R_samples <- rstan::extract(results_model_four_ch_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_03_R_samples <- rstan::extract(results_model_four_ch_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_04_R_samples <- rstan::extract(results_model_four_ch_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_05_R_samples <- rstan::extract(results_model_four_ch_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_06_R_samples <- rstan::extract(results_model_four_ch_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_07_R_samples <- rstan::extract(results_model_four_ch_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_08_R_samples <- rstan::extract(results_model_four_ch_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_09_R_samples <- rstan::extract(results_model_four_ch_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_10_R_samples <- rstan::extract(results_model_four_ch_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_11_R_samples <- rstan::extract(results_model_four_ch_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_ch_2021_12_R_samples <- rstan::extract(results_model_four_ch_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# 
# results_model_four_ch_2021_R_samples <- c(results_model_four_ch_2021_01_R_samples,
#                                            results_model_four_ch_2021_02_R_samples,
#                                            results_model_four_ch_2021_03_R_samples,
#                                            results_model_four_ch_2021_04_R_samples,
#                                            results_model_four_ch_2021_05_R_samples,
#                                            results_model_four_ch_2021_06_R_samples,
#                                            results_model_four_ch_2021_07_R_samples,
#                                            results_model_four_ch_2021_08_R_samples,
#                                            results_model_four_ch_2021_09_R_samples,
#                                            results_model_four_ch_2021_10_R_samples,
#                                            results_model_four_ch_2021_11_R_samples,
#                                            results_model_four_ch_2021_12_R_samples)
# 
# summary_results_model_four_2021_R_over_all <- tibble(country = "Switzerland",
#                                                       mean = round(mean(results_model_four_ch_2021_R_samples), 2),
#                                                       quantile_025 = round(quantile(x = results_model_four_ch_2021_R_samples, probs = 0.025), 2),
#                                                       quantile_975 = round(quantile(x = results_model_four_ch_2021_R_samples, probs = 0.975), 2))
# 
# results_model_four_dk_2021_01_R_samples <- rstan::extract(results_model_four_dk_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_02_R_samples <- rstan::extract(results_model_four_dk_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_03_R_samples <- rstan::extract(results_model_four_dk_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_04_R_samples <- rstan::extract(results_model_four_dk_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_05_R_samples <- rstan::extract(results_model_four_dk_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_06_R_samples <- rstan::extract(results_model_four_dk_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_07_R_samples <- rstan::extract(results_model_four_dk_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_08_R_samples <- rstan::extract(results_model_four_dk_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_09_R_samples <- rstan::extract(results_model_four_dk_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_10_R_samples <- rstan::extract(results_model_four_dk_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_11_R_samples <- rstan::extract(results_model_four_dk_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_dk_2021_12_R_samples <- rstan::extract(results_model_four_dk_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# 
# results_model_four_dk_2021_R_samples <- c(results_model_four_dk_2021_01_R_samples,
#                                            results_model_four_dk_2021_02_R_samples,
#                                            results_model_four_dk_2021_03_R_samples,
#                                            results_model_four_dk_2021_04_R_samples,
#                                            results_model_four_dk_2021_05_R_samples,
#                                            results_model_four_dk_2021_06_R_samples,
#                                            results_model_four_dk_2021_07_R_samples,
#                                            results_model_four_dk_2021_08_R_samples,
#                                            results_model_four_dk_2021_09_R_samples,
#                                            results_model_four_dk_2021_10_R_samples,
#                                            results_model_four_dk_2021_11_R_samples,
#                                            results_model_four_dk_2021_12_R_samples)
# 
# summary_results_model_four_2021_R_over_all <- bind_rows(summary_results_model_four_2021_R_over_all,
#                                                          tibble(country = "Denmark",
#                                                                 mean = round(mean(results_model_four_dk_2021_R_samples), 2),
#                                                                 quantile_025 = round(quantile(x = results_model_four_dk_2021_R_samples, probs = 0.025), 2),
#                                                                 quantile_975 = round(quantile(x = results_model_four_dk_2021_R_samples, probs = 0.975), 2)))
# 
# results_model_four_de_2021_01_R_samples <- rstan::extract(results_model_four_de_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_02_R_samples <- rstan::extract(results_model_four_de_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_03_R_samples <- rstan::extract(results_model_four_de_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_04_R_samples <- rstan::extract(results_model_four_de_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_05_R_samples <- rstan::extract(results_model_four_de_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_06_R_samples <- rstan::extract(results_model_four_de_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_07_R_samples <- rstan::extract(results_model_four_de_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_08_R_samples <- rstan::extract(results_model_four_de_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_09_R_samples <- rstan::extract(results_model_four_de_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_10_R_samples <- rstan::extract(results_model_four_de_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_11_R_samples <- rstan::extract(results_model_four_de_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# results_model_four_de_2021_12_R_samples <- rstan::extract(results_model_four_de_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,1][1:2000]
# 
# results_model_four_de_2021_R_samples <- c(results_model_four_de_2021_01_R_samples,
#                                            results_model_four_de_2021_02_R_samples,
#                                            results_model_four_de_2021_03_R_samples,
#                                            results_model_four_de_2021_04_R_samples,
#                                            results_model_four_de_2021_05_R_samples,
#                                            results_model_four_de_2021_06_R_samples,
#                                            results_model_four_de_2021_07_R_samples,
#                                            results_model_four_de_2021_08_R_samples,
#                                            results_model_four_de_2021_09_R_samples,
#                                            results_model_four_de_2021_10_R_samples,
#                                            results_model_four_de_2021_11_R_samples,
#                                            results_model_four_de_2021_12_R_samples)
# 
# summary_results_model_four_2021_R_over_all <- bind_rows(summary_results_model_four_2021_R_over_all,
#                                                          tibble(country = "Germany",
#                                                                 mean = round(mean(results_model_four_de_2021_R_samples), 2),
#                                                                 quantile_025 = round(quantile(x = results_model_four_de_2021_R_samples, probs = 0.025), 2),
#                                                                 quantile_975 = round(quantile(x = results_model_four_de_2021_R_samples, probs = 0.975), 2)))
# 
# 
# # k
# results_model_four_ch_2021_01_k_samples <- rstan::extract(results_model_four_ch_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_02_k_samples <- rstan::extract(results_model_four_ch_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_03_k_samples <- rstan::extract(results_model_four_ch_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_04_k_samples <- rstan::extract(results_model_four_ch_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_05_k_samples <- rstan::extract(results_model_four_ch_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_06_k_samples <- rstan::extract(results_model_four_ch_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_07_k_samples <- rstan::extract(results_model_four_ch_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_08_k_samples <- rstan::extract(results_model_four_ch_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_09_k_samples <- rstan::extract(results_model_four_ch_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_10_k_samples <- rstan::extract(results_model_four_ch_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_11_k_samples <- rstan::extract(results_model_four_ch_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_ch_2021_12_k_samples <- rstan::extract(results_model_four_ch_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# 
# results_model_four_ch_2021_k_samples <- c(results_model_four_ch_2021_01_k_samples,
#                                            results_model_four_ch_2021_02_k_samples,
#                                            results_model_four_ch_2021_03_k_samples,
#                                            results_model_four_ch_2021_04_k_samples,
#                                            results_model_four_ch_2021_05_k_samples,
#                                            results_model_four_ch_2021_06_k_samples,
#                                            results_model_four_ch_2021_07_k_samples,
#                                            results_model_four_ch_2021_08_k_samples,
#                                            results_model_four_ch_2021_09_k_samples,
#                                            results_model_four_ch_2021_10_k_samples,
#                                            results_model_four_ch_2021_11_k_samples,
#                                            results_model_four_ch_2021_12_k_samples)
# 
# summary_results_model_four_2021_k_over_all <- tibble(country = "Switzerland",
#                                                       mean = round(mean(results_model_four_ch_2021_k_samples), 2),
#                                                       quantile_025 = round(quantile(x = results_model_four_ch_2021_k_samples, probs = 0.025), 2),
#                                                       quantile_975 = round(quantile(x = results_model_four_ch_2021_k_samples, probs = 0.975), 2))
# 
# results_model_four_dk_2021_01_k_samples <- rstan::extract(results_model_four_dk_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_02_k_samples <- rstan::extract(results_model_four_dk_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_03_k_samples <- rstan::extract(results_model_four_dk_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_04_k_samples <- rstan::extract(results_model_four_dk_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_05_k_samples <- rstan::extract(results_model_four_dk_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_06_k_samples <- rstan::extract(results_model_four_dk_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_07_k_samples <- rstan::extract(results_model_four_dk_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_08_k_samples <- rstan::extract(results_model_four_dk_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_09_k_samples <- rstan::extract(results_model_four_dk_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_10_k_samples <- rstan::extract(results_model_four_dk_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_11_k_samples <- rstan::extract(results_model_four_dk_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_dk_2021_12_k_samples <- rstan::extract(results_model_four_dk_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# 
# results_model_four_dk_2021_k_samples <- c(results_model_four_dk_2021_01_k_samples,
#                                            results_model_four_dk_2021_02_k_samples,
#                                            results_model_four_dk_2021_03_k_samples,
#                                            results_model_four_dk_2021_04_k_samples,
#                                            results_model_four_dk_2021_05_k_samples,
#                                            results_model_four_dk_2021_06_k_samples,
#                                            results_model_four_dk_2021_07_k_samples,
#                                            results_model_four_dk_2021_08_k_samples,
#                                            results_model_four_dk_2021_09_k_samples,
#                                            results_model_four_dk_2021_10_k_samples,
#                                            results_model_four_dk_2021_11_k_samples,
#                                            results_model_four_dk_2021_12_k_samples)
# 
# summary_results_model_four_2021_k_over_all <- bind_rows(summary_results_model_four_2021_k_over_all,
#                                                          tibble(country = "Denmark",
#                                                                 mean = round(mean(results_model_four_dk_2021_k_samples), 2),
#                                                                 quantile_025 = round(quantile(x = results_model_four_dk_2021_k_samples, probs = 0.025), 2),
#                                                                 quantile_975 = round(quantile(x = results_model_four_dk_2021_k_samples, probs = 0.975), 2)))
# 
# results_model_four_de_2021_01_k_samples <- rstan::extract(results_model_four_de_2021_01, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_02_k_samples <- rstan::extract(results_model_four_de_2021_02, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_03_k_samples <- rstan::extract(results_model_four_de_2021_03, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_04_k_samples <- rstan::extract(results_model_four_de_2021_04, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_05_k_samples <- rstan::extract(results_model_four_de_2021_05, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_06_k_samples <- rstan::extract(results_model_four_de_2021_06, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_07_k_samples <- rstan::extract(results_model_four_de_2021_07, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_08_k_samples <- rstan::extract(results_model_four_de_2021_08, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_09_k_samples <- rstan::extract(results_model_four_de_2021_09, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_10_k_samples <- rstan::extract(results_model_four_de_2021_10, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_11_k_samples <- rstan::extract(results_model_four_de_2021_11, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# results_model_four_de_2021_12_k_samples <- rstan::extract(results_model_four_de_2021_12, permuted = FALSE, inc_warmup = FALSE)[,,2][1:2000]
# 
# results_model_four_de_2021_k_samples <- c(results_model_four_de_2021_01_k_samples,
#                                            results_model_four_de_2021_02_k_samples,
#                                            results_model_four_de_2021_03_k_samples,
#                                            results_model_four_de_2021_04_k_samples,
#                                            results_model_four_de_2021_05_k_samples,
#                                            results_model_four_de_2021_06_k_samples,
#                                            results_model_four_de_2021_07_k_samples,
#                                            results_model_four_de_2021_08_k_samples,
#                                            results_model_four_de_2021_09_k_samples,
#                                            results_model_four_de_2021_10_k_samples,
#                                            results_model_four_de_2021_11_k_samples,
#                                            results_model_four_de_2021_12_k_samples)
# 
# summary_results_model_four_2021_k_over_all <- bind_rows(summary_results_model_four_2021_k_over_all,
#                                                          tibble(country = "Germany",
#                                                                 mean = round(mean(results_model_four_de_2021_k_samples), 2),
#                                                                 quantile_025 = round(quantile(x = results_model_four_de_2021_k_samples, probs = 0.025), 2),
#                                                                 quantile_975 = round(quantile(x = results_model_four_de_2021_k_samples, probs = 0.975), 2)))
# 
# 
# 
# # have a look at the range of estimates of Re and k ----
# 
# # Re
# Re_estimate_model_four_ch_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% dplyr::select(R_estimate))
# Re_estimate_model_four_dk_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% dplyr::select(R_estimate))
# Re_estimate_model_four_de_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% dplyr::select(R_estimate))
# 
# Re_estimate_model_four_ch_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% dplyr::select(R_estimate))
# Re_estimate_model_four_dk_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% dplyr::select(R_estimate))
# Re_estimate_model_four_de_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% dplyr::select(R_estimate))
# 
# Re_n_na_Rhat_model_four_2021_ch <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(R_Rhat)))
# Re_n_na_Rhat_model_four_2021_dk <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(R_Rhat)))
# Re_n_na_Rhat_model_four_2021_de <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(R_Rhat)))
# 
# Re_min_Rhat_model_four_2021_ch <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(R_Rhat), na.rm = TRUE)
# Re_min_Rhat_model_four_2021_dk <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(R_Rhat), na.rm = TRUE)
# Re_min_Rhat_model_four_2021_de <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(R_Rhat), na.rm = TRUE)
# 
# Re_max_Rhat_model_four_2021_ch <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(R_Rhat), na.rm = TRUE)
# Re_max_Rhat_model_four_2021_dk <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(R_Rhat), na.rm = TRUE)
# Re_max_Rhat_model_four_2021_de <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(R_Rhat), na.rm = TRUE)
# 
# summary_results_model_four_2021_R_months <- tibble(country = c("Switzerland", "Denmark", "Germany"),
#                                                     min_month = c(Re_estimate_model_four_ch_2021_min, Re_estimate_model_four_dk_2021_min, Re_estimate_model_four_de_2021_min),
#                                                     max_month = c(Re_estimate_model_four_ch_2021_max, Re_estimate_model_four_dk_2021_max, Re_estimate_model_four_de_2021_max),
#                                                     n_na_R_Rhat = c(Re_n_na_Rhat_model_four_2021_ch, Re_n_na_Rhat_model_four_2021_dk, Re_n_na_Rhat_model_four_2021_de),
#                                                     min_R_Rhat = c(Re_min_Rhat_model_four_2021_ch, Re_min_Rhat_model_four_2021_dk, Re_min_Rhat_model_four_2021_de),
#                                                     max_R_Rhat = c(Re_max_Rhat_model_four_2021_ch, Re_max_Rhat_model_four_2021_dk, Re_max_Rhat_model_four_2021_de))
# 
# summary_results_model_four_2021_R <- summary_results_model_four_2021_R_over_all %>%
#   full_join(summary_results_model_four_2021_R_months, by = "country")
# 
# 
# # k
# k_estimate_model_four_ch_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% dplyr::select(k_estimate))
# k_estimate_model_four_dk_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% dplyr::select(k_estimate))
# k_estimate_model_four_de_2021_min <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% dplyr::select(k_estimate))
# 
# k_estimate_model_four_ch_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% dplyr::select(k_estimate))
# k_estimate_model_four_dk_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% dplyr::select(k_estimate))
# k_estimate_model_four_de_2021_max <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% dplyr::select(k_estimate))
# 
# k_n_na_Rhat_model_four_2021_ch <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(k_Rhat)))
# k_n_na_Rhat_model_four_2021_dk <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(k_Rhat)))
# k_n_na_Rhat_model_four_2021_de <- sum(is.na(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(k_Rhat)))
# 
# k_min_Rhat_model_four_2021_ch <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(k_Rhat), na.rm = TRUE)
# k_min_Rhat_model_four_2021_dk <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(k_Rhat), na.rm = TRUE)
# k_min_Rhat_model_four_2021_de <- min(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(k_Rhat), na.rm = TRUE)
# 
# k_max_Rhat_model_four_2021_ch <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Switzerland") %>% pull(k_Rhat), na.rm = TRUE)
# k_max_Rhat_model_four_2021_dk <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Denmark") %>% pull(k_Rhat), na.rm = TRUE)
# k_max_Rhat_model_four_2021_de <- max(results_model_four_ch_dk_de_2021_months %>% filter(country == "Germany") %>% pull(k_Rhat), na.rm = TRUE)
# 
# summary_results_model_four_2021_k_months <- tibble(country = c("Switzerland", "Denmark", "Germany"),
#                                                     min_month = c(k_estimate_model_four_ch_2021_min, k_estimate_model_four_dk_2021_min, k_estimate_model_four_de_2021_min),
#                                                     max_month = c(k_estimate_model_four_ch_2021_max, k_estimate_model_four_dk_2021_max, k_estimate_model_four_de_2021_max),
#                                                     n_na_k_Rhat = c(k_n_na_Rhat_model_four_2021_ch, k_n_na_Rhat_model_four_2021_dk, k_n_na_Rhat_model_four_2021_de),
#                                                     min_k_Rhat = c(k_min_Rhat_model_four_2021_ch, k_min_Rhat_model_four_2021_dk, k_min_Rhat_model_four_2021_de),
#                                                     max_k_Rhat = c(k_max_Rhat_model_four_2021_ch, k_max_Rhat_model_four_2021_dk, k_max_Rhat_model_four_2021_de))
# 
# summary_results_model_four_2021_k <- summary_results_model_four_2021_k_over_all %>%
#   full_join(summary_results_model_four_2021_k_months, by = "country")
# 
# 
# 
# # print summaries ----
# print(results_model_four_checks_ch)
# print(results_model_four_checks_dk)
# print(results_model_four_checks_de)
# 
# print(summary_results_model_four_2021_R)
# print(summary_results_model_four_2021_k)
# 


